name: release-please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Release Please
        uses: nick-fields/retry@v3
        with:
          max_attempts: 3
          retry_wait_seconds: 30
          retry_on: error
          timeout_minutes: 10
          command: |
            set -euo pipefail

            run_release_please() {
              local description="$1"
              shift

              echo "🔁 Ejecutando ${description}"
              if ! "$@"; then
                local exit_code=$?
                echo "::error::${description} falló con código ${exit_code}." >&2
                return ${exit_code}
              fi
            }

            run_release_please "release-pr" \
              npx --yes release-please release-pr \
              --debug \
              --token="${{ secrets.GITHUB_TOKEN }}" \
              --repo-url="${{ github.repository }}" \
              --config-file="release-please-config.json" \
              --manifest-file=".release-please-manifest.json"

            run_release_please "github-release" \
              npx --yes release-please github-release \
              --debug \
              --token="${{ secrets.GITHUB_TOKEN }}" \
              --repo-url="${{ github.repository }}" \
              --config-file="release-please-config.json" \
              --manifest-file=".release-please-manifest.json"
